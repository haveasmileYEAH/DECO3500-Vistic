<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Street Challenge ‚Äì Display</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="/css/display.css" rel="stylesheet">
</head>
<body>
  <div class="wrap">
    <div class="row between" style="margin-bottom:16px">
      <div class="row" style="gap:8px"><span>Round Code</span><span id="codeEl" class="code">‚Äî‚Äî‚Äî</span></div>
      <div class="row" style="gap:8px">
        <label class="small">Change Code:</label>
        <input id="codeInput" class="input" placeholder="ABC123">
        <button id="apply" class="btn">Apply</button>
      </div>
    </div>

    <div class="card">
      <div id="title" class="title">Loading title‚Ä¶</div>
      <div id="body" class="body">Loading body‚Ä¶</div>
    </div>

    <!-- ‚≠ê Êñ∞Â¢ûÔºö‰∫åÁª¥Á†ÅÂç°Áâá -->
    <div class="card" id="qrCard" style="display:none; margin-top:16px">
      <div class="row between" style="margin-bottom: 12px;">
        <span class="chip">üì± Scan to Join as Audience</span>
        <span id="qrRoomCode" class="code">‚Äî</span>
      </div>
      <div style="text-align: center; padding: 20px; background: #f9fafb; border-radius: 12px;">
        <img id="qrCanvas" width="200" height="200" style="display:inline-block; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" alt="QR Code" />
        <p style="margin-top: 16px; font-size: 14px; color: #64748b; font-weight: 500;">
          üì∑ Scan with your phone to join as audience
        </p>
      </div>
    </div>

    <!-- ÂΩìÂâçÈóÆÈ¢òÂç°Áâá -->
    <div class="card" id="questionCard" style="display:none; margin-top:16px">
      <div class="row between">
        <span class="chip">Current Question</span>
        <span id="qNumber" class="small">Q ‚Äî / ‚Äî</span>
      </div>
      <div id="currentQuestion" class="question-box">Waiting for question...</div>
      <div class="row" style="margin-top:10px; gap:12px">
        <span id="questionType" class="small muted"></span>
        <span id="timeLimit" class="small muted"></span>
      </div>
    </div>

    <div class="card">
  <div class="vote-chart">
    <div class="chart-title">
      <span class="chip">Live Votes</span>
    </div>
    <div class="chart-container">
      <!-- True Êü± -->
      <div class="chart-bar-wrapper">
        <div class="chart-label">üëç True</div>
        <div class="chart-bar-bg">
          <div id="barTrue" class="chart-bar chart-bar-true" style="height:0%">
            <span class="chart-value" id="valueTrue">0</span>
          </div>
        </div>
        <div class="chart-count" id="countTrue">0 votes</div>
      </div>
      
      <!-- False Êü± -->
      <div class="chart-bar-wrapper">
        <div class="chart-label">üëé False</div>
        <div class="chart-bar-bg">
          <div id="barFalse" class="chart-bar chart-bar-false" style="height:0%">
            <span class="chart-value" id="valueFalse">0</span>
          </div>
        </div>
        <div class="chart-count" id="countFalse">0 votes</div>
      </div>
    </div>
    
    <!-- ÁªüËÆ°‰ø°ÊÅØ -->
    <div class="chart-stats" id="stat">
      Total: 0 votes | True: 0% | False: 0%
    </div>
  </div>
  
  <div id="revealBox" style="margin-top:10px; display:none">
    <span class="chip">Revealed</span> 
    <span id="truth" class="truth">Truth: ‚Äî</span>
  </div>
</div>

      <div class="card">
        <div class="row between"><span class="chip">Live Hints</span><div class="small">Newest last ‚Ä¢ auto-scroll</div></div>
        <ul id="messages" class="list"></ul>
      </div>
    </div>

    <div class="footer" style="margin-top:12px">
      Example: <span id="example"></span>
    </div>
  </div>

  <!-- ÁéØÂ¢ÉÂèòÈáè -->
  <script src="/env.js"></script>

  <!-- ËΩÆËØ¢ËÑöÊú¨ -->
  <script>
    setInterval(async function() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('code');
        
        if (!roomCode || !window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) return;
        
        const response = await fetch(
          `${window.SUPABASE_URL}/rest/v1/rounds?code=eq.${roomCode}&select=*`, 
          {
            headers: {
              'apikey': window.SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`
            }
          }
        );
        
        const data = await response.json();
        if (data && data[0]) {
          const round = data[0];
          
          const questionCard = document.getElementById('questionCard');
          const currentQuestion = document.getElementById('currentQuestion');
          const qNumber = document.getElementById('qNumber');
          const questionType = document.getElementById('questionType');
          const timeLimit = document.getElementById('timeLimit');
          
          if (round.current_question && round.current_question.trim()) {
            questionCard.style.display = 'block';
            currentQuestion.textContent = round.current_question;
            
            const qNum = round.current_question_number || '‚Äî';
            const qTotal = round.current_question_total || '‚Äî';
            qNumber.textContent = `Q ${qNum} / ${qTotal}`;
            
            const qType = round.current_question_type === 'short' ? 'Short Answer' : 'True / False';
            questionType.textContent = `Type: ${qType}`;
            
            if (round.current_question_time_limit) {
              timeLimit.textContent = `Time Limit: ${round.current_question_time_limit}s`;
            } else {
              timeLimit.textContent = '';
            }
            
            console.log('üîÑ [Display] ÈóÆÈ¢òÂ∑≤Êõ¥Êñ∞:', round.current_question.substring(0, 50) + '...');
          } else {
            questionCard.style.display = 'none';
          }
        }
      } catch (e) {
        console.error('‚ùå [Display] Âà∑Êñ∞Â§±Ë¥•:', e);
      }
    }, 3000);
    
    console.log('‚úÖ [Display] ËΩÆËØ¢Â∑≤ÂêØÂä®ÔºàÊØè 3 ÁßíÔºâ');
  </script>

  <script type="module" src="/js/display.js?v=3"></script>
</body>
</html>