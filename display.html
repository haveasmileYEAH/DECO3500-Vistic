<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Street Challenge â€“ Display</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- âŒ åˆ é™¤è¿™è¡Œï¼ä¸è¦ç”¨ meta refresh -->
  <!-- <meta http-equiv="refresh" content="5"> -->
  <link href="/css/display.css" rel="stylesheet">
</head>
<body>
  <div class="wrap">
    <div class="row between" style="margin-bottom:16px">
      <div class="row" style="gap:8px"><span>Round Code</span><span id="codeEl" class="code">â€”â€”â€”</span></div>
      <div class="row" style="gap:8px">
        <label class="small">Change Code:</label>
        <input id="codeInput" class="input" placeholder="ABC123">
        <button id="apply" class="btn">Apply</button>
      </div>
    </div>

    <div class="card">
      <div id="title" class="title">Loading titleâ€¦</div>
      <div id="body" class="body">Loading bodyâ€¦</div>
    </div>

    <!-- æ–°å¢ï¼šå½“å‰é—®é¢˜å¡ç‰‡ -->
    <div class="card" id="questionCard" style="display:none; margin-top:16px">
      <div class="row between">
        <span class="chip">Current Question</span>
        <span id="qNumber" class="small">Q â€” / â€”</span>
      </div>
      <div id="currentQuestion" class="question-box">Waiting for question...</div>
      <div class="row" style="margin-top:10px; gap:12px">
        <span id="questionType" class="small muted"></span>
        <span id="timeLimit" class="small muted"></span>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <div class="row between"><span class="chip">Live Votes</span><div id="stat" class="stat">ğŸ‘ 0 | ğŸ‘ 0 (0% up)</div></div>
        <div class="bar" style="margin-top:10px"><div id="barUp" class="up" style="width:0%"></div></div>
        <div id="revealBox" style="margin-top:10px; display:none"><span class="chip">Revealed</span> <span id="truth" class="truth">Truth: â€”</span></div>
      </div>

      <div class="card">
        <div class="row between"><span class="chip">Live Hints</span><div class="small">Newest last â€¢ auto-scroll</div></div>
        <ul id="messages" class="list"></ul>
      </div>
    </div>

    <div class="footer" style="margin-top:12px">
      Example: <span id="example"></span>
    </div>
  </div>

  <!-- â­ ç¯å¢ƒå˜é‡ï¼ˆå¿…é¡»åœ¨æœ€å‰é¢ï¼‰ -->
  <script src="/env.js"></script>

  <!-- â­ è½®è¯¢è„šæœ¬ï¼ˆåœ¨ display.js ä¹‹å‰ï¼‰ -->
  <script>
    // ç®€å•çš„è½®è¯¢æ–¹æ¡ˆ
    setInterval(async function() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('code');
        
        if (!roomCode || !window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) return;
        
        const response = await fetch(
          `${window.SUPABASE_URL}/rest/v1/rounds?code=eq.${roomCode}&select=*`, 
          {
            headers: {
              'apikey': window.SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`
            }
          }
        );
        
        const data = await response.json();
        if (data && data[0]) {
          const round = data[0];
          
          // æ›´æ–°é—®é¢˜æ˜¾ç¤º
          const questionCard = document.getElementById('questionCard');
          const currentQuestion = document.getElementById('currentQuestion');
          const qNumber = document.getElementById('qNumber');
          const questionType = document.getElementById('questionType');
          const timeLimit = document.getElementById('timeLimit');
          
          if (round.current_question && round.current_question.trim()) {
            questionCard.style.display = 'block';
            currentQuestion.textContent = round.current_question;
            
            const qNum = round.current_question_number || 'â€”';
            const qTotal = round.current_question_total || 'â€”';
            qNumber.textContent = `Q ${qNum} / ${qTotal}`;
            
            const qType = round.current_question_type === 'short' ? 'Short Answer' : 'True / False';
            questionType.textContent = `Type: ${qType}`;
            
            if (round.current_question_time_limit) {
              timeLimit.textContent = `Time Limit: ${round.current_question_time_limit}s`;
            } else {
              timeLimit.textContent = '';
            }
            
            console.log('ğŸ”„ [Display] é—®é¢˜å·²æ›´æ–°:', round.current_question.substring(0, 50) + '...');
          } else {
            questionCard.style.display = 'none';
          }
        }
      } catch (e) {
        console.error('âŒ [Display] åˆ·æ–°å¤±è´¥:', e);
      }
    }, 3000); // æ¯ 3 ç§’æ£€æŸ¥ä¸€æ¬¡
    
    console.log('âœ… [Display] è½®è¯¢å·²å¯åŠ¨ï¼ˆæ¯ 3 ç§’ï¼‰');
  </script>

  <!-- â­ display.jsï¼ˆä¸æ˜¯ audience.jsï¼ï¼‰ -->
  <script type="module" src="/js/display.js?v=2"></script>
</body>
</html>