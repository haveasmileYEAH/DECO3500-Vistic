<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Street Challenge ‚Äì Audience Vote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="/css/audience.css" rel="stylesheet">

  <!-- New Theme 2 code Load the new v2 CSS only when ?theme=v2 -->
  <script>
    (function(){
      const p=new URLSearchParams(location.search);
      if(p.get('theme')==='v2'){
        const link=document.createElement('link');
        link.rel='stylesheet';
        link.href='/css/audience_v2.css?v=dev1';
        document.head.appendChild(link);
      }
    })();
  </script>
</head>
<body>
  <h1>Street Challenge - Audience</h1>

  <div class="card">
    <div class="row">
      <label class="small">Round Code</label>
      <input id="codeInput" placeholder="ABC123" style="flex:0 0 120px">
      <button id="apply">Join</button>
      <span id="joined" class="small"></span>
    </div>
  </div>

  <div class="card">
    <div id="title" class="title">Enter code & join to see the story‚Ä¶</div>
    <div id="body" class="body"></div>
  </div>

  <div class="card" id="questionCard" style="display:none">
    <div class="question-header">
      <span class="badge">Current Question</span>
      <span id="qNumber" class="small">Q ‚Äî / ‚Äî</span>
    </div>
    <div id="currentQuestion" class="question-text">Waiting for question...</div>
    <div id="questionType" class="small muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
  <div class="row" style="margin-bottom: 12px;">
    <button id="up">üëç Believe True</button>
    <button id="down">üëé Believe False</button>
  </div>
  
  <div class="vote-chart">
    <div class="chart-title">Live Voting Results</div>
    <div class="chart-container">
      <div class="chart-bar-wrapper">
        <div class="chart-label">üëç True</div>
        <div class="chart-bar-bg">
          <div id="barTrue" class="chart-bar chart-bar-true" style="height:0%">
            <span class="chart-value" id="valueTrue">0</span>
          </div>
        </div>
        <div class="chart-count" id="countTrue">0 votes</div>
      </div>
      <div class="chart-bar-wrapper">
        <div class="chart-label">üëé False</div>
        <div class="chart-bar-bg">
          <div id="barFalse" class="chart-bar chart-bar-false" style="height:0%">
            <span class="chart-value" id="valueFalse">0</span>
          </div>
        </div>
        <div class="chart-count" id="countFalse">0 votes</div>
      </div>
    </div>
    
    <div class="chart-stats" id="stat">
      Total: 0 votes | True: 0% | False: 0%
    </div>
  </div>
</div>

  <div class="card">
    <div class="row">
      <input id="hint" placeholder="Optional reason / comment‚Ä¶" style="flex:1">
      <button id="send">Send</button>
    </div>
    <ul id="messages" class="list"></ul>
  </div>
  <script src="/env.js"></script>
  <script>
    setInterval(async function() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('code');
        
        if (!roomCode || !window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) return;
        
        const response = await fetch(
          `${window.SUPABASE_URL}/rest/v1/rounds?code=eq.${roomCode}&select=*`, 
          {
            headers: {
              'apikey': window.SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`
            }
          }
        );
        
        const data = await response.json();
        if (data && data[0]) {
          const round = data[0];
          const questionCard = document.getElementById('questionCard');
          const currentQuestion = document.getElementById('currentQuestion');
          const qNumber = document.getElementById('qNumber');
          const questionType = document.getElementById('questionType');
          
          if (round.current_question && round.current_question.trim()) {
            questionCard.style.display = 'block';
            currentQuestion.textContent = round.current_question;
            
            const qNum = round.current_question_number || '‚Äî';
            const qTotal = round.current_question_total || '‚Äî';
            qNumber.textContent = `Q ${qNum} / ${qTotal}`;
            
            const qType = round.current_question_type === 'short' ? 'Short Answer' : 'True / False';
            questionType.textContent = `Type: ${qType}`;
          } else {
            questionCard.style.display = 'none';
          }
        }
      } catch (e) {}
    }, 3000);
  </script>
  <script type="module" src="/js/audience.js?v=3"></script>
</body>
</html>