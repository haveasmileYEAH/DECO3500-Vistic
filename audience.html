<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Street Challenge â€“ Audience Vote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- âŒ åˆ é™¤ meta refreshï¼Œä½¿ç”¨ JavaScript è½®è¯¢ä»£æ›¿ -->
  <!-- <meta http-equiv="refresh" content="5"> -->
  <link href="/css/audience.css" rel="stylesheet">

  <!-- New Theme 2 code Load the new v2 CSS only when ?theme=v2 -->
  <script>
    (function(){
      const p=new URLSearchParams(location.search);
      if(p.get('theme')==='v2'){
        const link=document.createElement('link');
        link.rel='stylesheet';
        link.href='/css/audience_v2.css?v=dev1';
        document.head.appendChild(link);
      }
    })();
  </script>

  <!-- New Theme 2 code Load the new v2 CSS only when ?theme=v2 -->

</head>
<body>
  <h1>Street Challenge â€“ Audience</h1>

  <div class="card">
    <div class="row">
      <label class="small">Round Code</label>
      <input id="codeInput" placeholder="ABC123" style="flex:0 0 120px">
      <button id="apply">Join</button>
      <span id="joined" class="small"></span>
    </div>
  </div>

  <div class="card">
    <div id="title" class="title">Enter code & join to see the storyâ€¦</div>
    <div id="body" class="body"></div>
  </div>

  <!-- æ–°å¢ï¼šå½“å‰é—®é¢˜å¡ç‰‡ -->
  <div class="card" id="questionCard" style="display:none">
    <div class="question-header">
      <span class="badge">Current Question</span>
      <span id="qNumber" class="small">Q â€” / â€”</span>
    </div>
    <div id="currentQuestion" class="question-text">Waiting for question...</div>
    <div id="questionType" class="small muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
  <div class="row" style="margin-bottom: 12px;">
    <button id="up">ğŸ‘ Believe True</button>
    <button id="down">ğŸ‘ Believe False</button>
  </div>
  
  <!-- â­ æ–°å¢ï¼šæŸ±çŠ¶å›¾ -->
  <div class="vote-chart">
    <div class="chart-title">Live Voting Results</div>
    <div class="chart-container">
      <!-- True æŸ± -->
      <div class="chart-bar-wrapper">
        <div class="chart-label">ğŸ‘ True</div>
        <div class="chart-bar-bg">
          <div id="barTrue" class="chart-bar chart-bar-true" style="height:0%">
            <span class="chart-value" id="valueTrue">0</span>
          </div>
        </div>
        <div class="chart-count" id="countTrue">0 votes</div>
      </div>
      
      <!-- False æŸ± -->
      <div class="chart-bar-wrapper">
        <div class="chart-label">ğŸ‘ False</div>
        <div class="chart-bar-bg">
          <div id="barFalse" class="chart-bar chart-bar-false" style="height:0%">
            <span class="chart-value" id="valueFalse">0</span>
          </div>
        </div>
        <div class="chart-count" id="countFalse">0 votes</div>
      </div>
    </div>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="chart-stats" id="stat">
      Total: 0 votes | True: 0% | False: 0%
    </div>
  </div>
</div>

  <div class="card">
    <div class="row">
      <input id="hint" placeholder="Optional reason / commentâ€¦" style="flex:1">
      <button id="send">Send</button>
    </div>
    <ul id="messages" class="list"></ul>
  </div>

  <!-- â­ ç¯å¢ƒå˜é‡ï¼ˆå¿…é¡»åœ¨æœ€å‰é¢ï¼‰ -->
  <script src="/env.js"></script>

  <!-- â­ ç®€å•çš„è½®è¯¢æ–¹æ¡ˆï¼ˆä¸ä¾èµ– audience.jsï¼‰ -->
  <script>
    setInterval(async function() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('code');
        
        if (!roomCode || !window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) return;
        
        const response = await fetch(
          `${window.SUPABASE_URL}/rest/v1/rounds?code=eq.${roomCode}&select=*`, 
          {
            headers: {
              'apikey': window.SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`
            }
          }
        );
        
        const data = await response.json();
        if (data && data[0]) {
          const round = data[0];
          
          // æ›´æ–°é—®é¢˜æ˜¾ç¤º
          const questionCard = document.getElementById('questionCard');
          const currentQuestion = document.getElementById('currentQuestion');
          const qNumber = document.getElementById('qNumber');
          const questionType = document.getElementById('questionType');
          
          if (round.current_question && round.current_question.trim()) {
            questionCard.style.display = 'block';
            currentQuestion.textContent = round.current_question;
            
            const qNum = round.current_question_number || 'â€”';
            const qTotal = round.current_question_total || 'â€”';
            qNumber.textContent = `Q ${qNum} / ${qTotal}`;
            
            const qType = round.current_question_type === 'short' ? 'Short Answer' : 'True / False';
            questionType.textContent = `Type: ${qType}`;
            
            console.log('ğŸ”„ [Audience] é—®é¢˜å·²æ›´æ–°:', round.current_question.substring(0, 50) + '...');
          } else {
            questionCard.style.display = 'none';
          }
        }
      } catch (e) {
        console.error('âŒ [Audience] åˆ·æ–°å¤±è´¥:', e);
      }
    }, 3000); // æ¯ 3 ç§’æ£€æŸ¥ä¸€æ¬¡
    
    console.log('âœ… [Audience] è½®è¯¢å·²å¯åŠ¨ï¼ˆæ¯ 3 ç§’ï¼‰');
  </script>

  <!-- â­ audience.js -->
  <script type="module" src="/js/audience.js?v=3"></script>
</body>
</html>