<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Street Challenge – Display</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- ❌ 删除这行！不要用 meta refresh -->
  <!-- <meta http-equiv="refresh" content="5"> -->
  <link href="/css/display.css" rel="stylesheet">
</head>
<body>
  <div class="wrap">
    <div class="row between" style="margin-bottom:16px">
      <div class="row" style="gap:8px"><span>Round Code</span><span id="codeEl" class="code">———</span></div>
      <div class="row" style="gap:8px">
        <label class="small">Change Code:</label>
        <input id="codeInput" class="input" placeholder="ABC123">
        <button id="apply" class="btn">Apply</button>
      </div>
    </div>

    <div class="card">
      <div id="title" class="title">Loading title…</div>
      <div id="body" class="body">Loading body…</div>
    </div>

    <!-- 新增：当前问题卡片 -->
    <div class="card" id="questionCard" style="display:none; margin-top:16px">
      <div class="row between">
        <span class="chip">Current Question</span>
        <span id="qNumber" class="small">Q — / —</span>
      </div>
      <div id="currentQuestion" class="question-box">Waiting for question...</div>
      <div class="row" style="margin-top:10px; gap:12px">
        <span id="questionType" class="small muted"></span>
        <span id="timeLimit" class="small muted"></span>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <div class="row between"><span class="chip">Live Votes</span><div id="stat" class="stat">👍 0 | 👎 0 (0% up)</div></div>
        <div class="bar" style="margin-top:10px"><div id="barUp" class="up" style="width:0%"></div></div>
        <div id="revealBox" style="margin-top:10px; display:none"><span class="chip">Revealed</span> <span id="truth" class="truth">Truth: —</span></div>
      </div>

      <div class="card">
        <div class="row between"><span class="chip">Live Hints</span><div class="small">Newest last • auto-scroll</div></div>
        <ul id="messages" class="list"></ul>
      </div>
    </div>

    <div class="footer" style="margin-top:12px">
      Example: <span id="example"></span>
    </div>
  </div>

  <!-- ⭐ 环境变量（必须在最前面） -->
  <script src="/env.js"></script>

  <!-- ⭐ 轮询脚本（在 display.js 之前） -->
  <script>
    // 简单的轮询方案
    setInterval(async function() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('code');
        
        if (!roomCode || !window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) return;
        
        const response = await fetch(
          `${window.SUPABASE_URL}/rest/v1/rounds?code=eq.${roomCode}&select=*`, 
          {
            headers: {
              'apikey': window.SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`
            }
          }
        );
        
        const data = await response.json();
        if (data && data[0]) {
          const round = data[0];
          
          // 更新问题显示
          const questionCard = document.getElementById('questionCard');
          const currentQuestion = document.getElementById('currentQuestion');
          const qNumber = document.getElementById('qNumber');
          const questionType = document.getElementById('questionType');
          const timeLimit = document.getElementById('timeLimit');
          
          if (round.current_question && round.current_question.trim()) {
            questionCard.style.display = 'block';
            currentQuestion.textContent = round.current_question;
            
            const qNum = round.current_question_number || '—';
            const qTotal = round.current_question_total || '—';
            qNumber.textContent = `Q ${qNum} / ${qTotal}`;
            
            const qType = round.current_question_type === 'short' ? 'Short Answer' : 'True / False';
            questionType.textContent = `Type: ${qType}`;
            
            if (round.current_question_time_limit) {
              timeLimit.textContent = `Time Limit: ${round.current_question_time_limit}s`;
            } else {
              timeLimit.textContent = '';
            }
            
            console.log('🔄 [Display] 问题已更新:', round.current_question.substring(0, 50) + '...');
          } else {
            questionCard.style.display = 'none';
          }
        }
      } catch (e) {
        console.error('❌ [Display] 刷新失败:', e);
      }
    }, 3000); // 每 3 秒检查一次
    
    console.log('✅ [Display] 轮询已启动（每 3 秒）');
  </script>

  <!-- ⭐ display.js（不是 audience.js！） -->
  <script type="module" src="/js/display.js?v=2"></script>
</body>
</html>